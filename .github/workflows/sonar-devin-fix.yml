name: SonarQube Vulnerability Fix with Devin

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  sonar-vulnerability-fix:
    name: Scan & Fix Vulnerabilities
    if: github.event.pull_request.user.login == 'bsmitches'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}
            -Dsonar.pullrequest.branch=${{ github.event.pull_request.head.ref }}
            -Dsonar.pullrequest.base=${{ github.event.pull_request.base.ref }}

      - name: Wait for SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
        run: |
          for i in $(seq 1 30); do
            PENDING=$(curl -s -u "${SONAR_TOKEN}:" \
              "${SONAR_HOST_URL}/api/ce/activity?component=${SONAR_PROJECT_KEY}&status=PENDING,IN_PROGRESS" | \
              jq -r '.tasks | length')
            if [ "$PENDING" -eq 0 ]; then
              echo "Analysis complete."
              exit 0
            fi
            echo "Waiting for analysis... (attempt ${i}/30)"
            sleep 10
          done
          echo "::warning::Timed out waiting for SonarQube analysis"

      - name: Check for critical/high vulnerabilities
        id: check-vulns
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
          SONAR_PROJECT_KEY: ${{ vars.SONAR_PROJECT_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          RESPONSE=$(curl -s -u "${SONAR_TOKEN}:" \
            "${SONAR_HOST_URL}/api/issues/search?componentKeys=${SONAR_PROJECT_KEY}&types=VULNERABILITY&severities=BLOCKER,CRITICAL&statuses=OPEN,CONFIRMED,REOPENED&pullRequest=${PR_NUMBER}&ps=100")

          TOTAL=$(echo "$RESPONSE" | jq -r '.total // 0')
          echo "vulnerability_count=${TOTAL}" >> "$GITHUB_OUTPUT"

          if [ "$TOTAL" -gt 0 ]; then
            echo "$RESPONSE" | jq -r \
              '.issues[] | "- [\(.severity)] \(.message) | File: \(.component | split(":") | last) | Line: \(.line // "N/A") | Rule: \(.rule)"' \
              > /tmp/vuln_details.txt
            echo "has_vulnerabilities=true" >> "$GITHUB_OUTPUT"
            echo "Found ${TOTAL} critical/high vulnerabilities:"
            cat /tmp/vuln_details.txt
          else
            echo "has_vulnerabilities=false" >> "$GITHUB_OUTPUT"
            echo "No critical/high vulnerabilities found."
          fi

      - name: Trigger Devin to fix vulnerabilities
        if: steps.check-vulns.outputs.has_vulnerabilities == 'true'
        env:
          DEVIN_API_TOKEN: ${{ secrets.DEVIN_API_TOKEN }}
          DEVIN_ORG_ID: ${{ vars.DEVIN_ORG_ID }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          REPO: ${{ github.repository }}
          VULN_COUNT: ${{ steps.check-vulns.outputs.vulnerability_count }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VULN_DETAILS=$(cat /tmp/vuln_details.txt)

          cat > /tmp/prompt.txt << PROMPT_EOF
          You are a security engineer. SonarQube has identified ${VULN_COUNT} critical/high severity vulnerability(ies) on PR #${PR_NUMBER} in repository ${REPO} on branch '${PR_BRANCH}'.

          Vulnerabilities:
          ${VULN_DETAILS}

          Instructions:
          1. Clone ${REPO} and checkout branch '${PR_BRANCH}'.
          2. For each vulnerability above, locate the affected file and line.
          3. Fix the root cause of each CRITICAL/BLOCKER vulnerability.
          4. Ensure fixes maintain existing functionality and follow the project's coding style.
          5. Commit with a message referencing the SonarQube rule IDs (e.g., "fix: resolve BLOCKER vulnerability [rule-id] in file.js").
          6. Push to branch '${PR_BRANCH}'.

          Constraints:
          - Only fix security vulnerabilities; do not refactor unrelated code.
          - Do not modify tests unless directly needed for a fix.
          - If a fix would cause breaking changes, comment on PR #${PR_NUMBER} explaining the issue instead.
          - Work autonomously without waiting for confirmation.
          PROMPT_EOF

          ESCAPED_PROMPT=$(jq -Rs . < /tmp/prompt.txt)

          jq -n \
            --argjson prompt "$ESCAPED_PROMPT" \
            --arg title "Fix SonarQube vulnerabilities on PR #${PR_NUMBER}" \
            --arg repo "$REPO" \
            '{
              prompt: $prompt,
              title: $title,
              repos: [$repo],
              tags: ["sonarqube-fix", "automated"]
            }' > /tmp/request.json

          HTTP_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            -H "Authorization: Bearer ${DEVIN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @/tmp/request.json \
            "https://api.devin.ai/v3beta1/organizations/${DEVIN_ORG_ID}/sessions")

          HTTP_BODY=$(echo "$HTTP_RESPONSE" | sed '/^HTTP_STATUS:/d')
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | grep '^HTTP_STATUS:' | cut -d: -f2)

          if [ "$HTTP_CODE" -eq 200 ]; then
            SESSION_URL=$(echo "$HTTP_BODY" | jq -r '.url')
            echo "Devin session created: ${SESSION_URL}"

            COMMENT_BODY=$(cat << EOF
          **SonarQube Vulnerability Fix Triggered**

          Found ${VULN_COUNT} critical/high severity vulnerability(ies). A Devin session has been created to fix them.

          **Devin Session:** ${SESSION_URL}

          **Vulnerabilities:**
          ${VULN_DETAILS}
          EOF
            )

            jq -n --arg body "$COMMENT_BODY" '{body: $body}' | \
              curl -s -X POST \
                -H "Authorization: token ${GITHUB_TOKEN}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/comments" \
                -d @-
          else
            echo "::error::Failed to create Devin session (HTTP ${HTTP_CODE})"
            echo "$HTTP_BODY"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          {
            echo "## SonarQube Vulnerability Scan"
            echo ""
            if [ "${{ steps.check-vulns.outputs.has_vulnerabilities }}" = "true" ]; then
              echo "Found **${{ steps.check-vulns.outputs.vulnerability_count }}** critical/high vulnerability(ies)."
              echo ""
              echo "A Devin session has been triggered to fix them automatically."
            else
              echo "No critical/high vulnerabilities found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
