<div class="reports-container">
  <h1>Reports</h1>

  <div class="error-alert" *ngIf="error" (click)="clearError()">
    <mat-icon>error</mat-icon>
    <span>{{ error }}</span>
    <mat-icon class="close-icon">close</mat-icon>
  </div>

  <mat-card *ngIf="!isLoading && clients.length === 0" class="no-clients-card">
    <mat-card-content>
      <p>You need to create at least one client before generating reports.</p>
      <a mat-raised-button color="primary" routerLink="/clients">Create Client</a>
    </mat-card-content>
  </mat-card>

  <div *ngIf="!isLoading && clients.length > 0">
    <mat-card class="filter-card">
      <mat-card-content>
        <div class="filter-row">
          <mat-form-field appearance="outline" class="client-select">
            <mat-label>Select Client</mat-label>
            <mat-select [(ngModel)]="selectedClientId" (selectionChange)="onClientChange()">
              <mat-option [value]="0">Choose a client...</mat-option>
              <mat-option *ngFor="let client of clients" [value]="client.id">
                {{ client.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <div class="export-buttons">
            <button mat-icon-button color="primary" matTooltip="Export as CSV" 
                    (click)="exportCsv()" [disabled]="!selectedClientId || reportLoading">
              <mat-icon>description</mat-icon>
            </button>
            <button mat-icon-button color="warn" matTooltip="Export as PDF" 
                    (click)="exportPdf()" [disabled]="!selectedClientId || reportLoading">
              <mat-icon>picture_as_pdf</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="loading-container" *ngIf="reportLoading">
      <mat-spinner></mat-spinner>
    </div>

    <div *ngIf="report && !reportLoading">
      <div class="stats-grid">
        <mat-card class="stat-card">
          <mat-card-content>
            <h3>Total Hours</h3>
            <span class="stat-value">{{ report.totalHours.toFixed(2) }}</span>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <h3>Total Entries</h3>
            <span class="stat-value">{{ report.entryCount }}</span>
          </mat-card-content>
        </mat-card>

        <mat-card class="stat-card">
          <mat-card-content>
            <h3>Average Hours per Entry</h3>
            <span class="stat-value">{{ averageHoursPerEntry.toFixed(2) }}</span>
          </mat-card-content>
        </mat-card>
      </div>

      <mat-card>
        <table mat-table [dataSource]="report.workEntries" class="full-width">
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef>Date</th>
            <td mat-cell *matCellDef="let entry">
              {{ entry.date | date:'shortDate' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="hours">
            <th mat-header-cell *matHeaderCellDef>Hours</th>
            <td mat-cell *matCellDef="let entry">
              <mat-chip color="primary">{{ entry.hours }} hours</mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Description</th>
            <td mat-cell *matCellDef="let entry">
              <span *ngIf="entry.description">{{ entry.description }}</span>
              <mat-chip *ngIf="!entry.description">No description</mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="created">
            <th mat-header-cell *matHeaderCellDef>Created</th>
            <td mat-cell *matCellDef="let entry">
              {{ entry.created_at | date:'shortDate' }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell no-data" [attr.colspan]="displayedColumns.length">
              No work entries found for this client.
            </td>
          </tr>
        </table>
      </mat-card>
    </div>

    <mat-card *ngIf="!selectedClientId && !reportLoading" class="select-client-card">
      <mat-card-content>
        <p>Select a client to view their time report.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner></mat-spinner>
  </div>
</div>
